#!/usr/bin/env python3

import argparse
import math
import os
import signal
from pygit2 import discover_repository, Oid, Repository, GIT_OBJ_TREE, GIT_OBJ_BLOB, GIT_OID_HEX_ZERO
from gi.repository import Gtk

parser = argparse.ArgumentParser(description='GIT blame interface')
parser.add_argument('filename', type=str, nargs='?', help='filename to analisys')
args = parser.parse_args()

cwd = os.getcwd()
repo_path = discover_repository(cwd)
repo = Repository(repo_path)

path = os.path.relpath(args.filename, repo.workdir)

def getBlobByTree(tree, item, tail):
	entry = next((e for e in tree if e.name == item), None)
	if not entry:
		return Oid(hex=GIT_OID_HEX_ZERO)
	obj = repo[entry.id]
	if obj.type == GIT_OBJ_TREE:
		return getBlobByTree(obj, tail[0], tail[1:])
	assert obj.type == GIT_OBJ_BLOB
	return obj.id

def getBlob(tree, path):
	parts = path.split(os.sep)
	return getBlobByTree(tree, parts[0], parts[1:])

class Revision:
	def __init__(self, commit):
		self.commit = commit
		self.id = commit.id
		self.parent_ids = set(commit.parent_ids)
		self.child_ids = set()
		self.file_id = getBlob(commit.tree, path)

	def addChild(self, id):
		self.child_ids.add(id)

	def label(self):
		return '%s:%s' % (str(self.id)[:7], str(self.file_id)[:7])


commits = dict()
todo = {repo.head.peel()}

while todo:
	commit = todo.pop()
	if commit.id in commits:
		continue
	revision = Revision(commit)
	if revision.file_id == Oid(hex=GIT_OID_HEX_ZERO):
		revision.parent_ids.clear()
	else:
		todo.update(commit.parents)
	commits[commit.id] = revision

# Accumulate childs
for c in commits.values():
	for p in c.parent_ids:
		commits[p].addChild(c.id)

def dropIdenticalChains():
	to_drop = set()
	for c in commits.values():
		if not c.parent_ids or not c.child_ids:
			continue
		parents = [commits[pp] for pp in c.parent_ids]
		if any((pp.file_id != c.file_id for pp in parents)):
			continue
		childs = [commits[cc] for cc in c.child_ids]
		if any((cc.file_id != c.file_id for cc in childs)):
			continue
		# unlink current and link childs and parent
		for cc in childs:
			cc.parent_ids.remove(c.id)
			cc.parent_ids.update(c.parent_ids)
		for pp in parents:
			pp.child_ids.remove(c.id)
			pp.child_ids.update(c.child_ids)
		# Cleanup current
		c.parent_ids.clear()
		c.child_ids.clear()
		to_drop.add(c.id)
	for cid in to_drop:
		del commits[cid]
	return bool(to_drop)


while dropIdenticalChains():
	pass


def cutNonPresent():
	root = next((c for c in commits.values() if not c.parent_ids), None)
	if root is None or root.file_id != Oid(hex=GIT_OID_HEX_ZERO):
		return False
	if not root.child_ids:	# HEAD revision
		return False
	for p in root.child_ids:
		parent = commits[p]
		parent.parent_ids.remove(root.id)
	del commits[root.id]
	return True


while cutNonPresent():
	pass


#print('digraph {')

#for c in commits.values():
#	print('\t"%s" [label="%s"];' % (str(c.id)[:7], c.label()))
#	for p in c.parent_ids:
#		print('\t"%s" -> "%s";' % (str(p)[:7], str(c.id)[:7]))
	#print(str(c.id)[:7], [str(i)[:7] for i in c.parent_ids], str(c.file_id)[:7])

#print('}')


class MainWindow(Gtk.Window):
	def __init__(self):
		super().__init__(title=path + ' - Gibli')
		self.maximize()

		self.vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=5)
		self.add(self.vbox)

		self.textview = Get.TextView()
		self.vbox.pack_start(self.textview, True, True, 0)

class Panel:
	def __init__(self, builder, textId, revId, authorId, messageId):
		self.textWidget = builder.get_object(textId)
		self.revWidget = builder.get_object(revId)
		self.authorWidget = builder.get_object(authorId)
		self.messageWidget = builder.get_object(messageId)

	def show(self, commit, path):
		blob_id = getBlob(commit.tree, path)
		blob_text = repo[blob_id].data

		self.textWidget.get_buffer().set_text(blob_text.decode('utf8'))
		self.revWidget.get_buffer().set_text(str(commit.id))
		self.authorWidget.get_buffer().set_text('%s <%s>' % (commit.author.name, commit.author.email))
		self.messageWidget.get_buffer().set_text(commit.message.splitlines()[0])


def draw_cb(widget, context):
	x = 150
	y = 75
	w = 50

	context.set_source_rgb(0, 0, 0)
	context.arc(x, y, 10, math.pi * 1.5, math.pi * .5)
	context.rel_line_to(-50, 0)
	context.arc(x - 50, y, 10, math.pi * .5, math.pi * 1.5)
	context.close_path()
	context.stroke_preserve()

	context.set_source_rgb(0.4, 1, 0.4)
	context.fill()

	context.move_to(x + 10, y)
	context.set_source_rgb(0, 0, 0)
	context.rel_curve_to(15, 0, 15, -30, 30, -30)
	context.stroke()

	return False


if __name__ == '__main__':
	signal.signal(signal.SIGINT, signal.SIG_DFL)

	builder = Gtk.Builder()
	builder.add_from_file('gibli.glade')

	main_window = builder.get_object('mainwindow')
	main_window.connect('delete-event', Gtk.main_quit)
	main_window.show_all()

	main_window.maximize()

	# Paned separator setup
	paned = builder.get_object('paned1')
	height = paned.get_allocated_height()
	paned.set_position(height * 0.7)

	leftPanel = Panel(builder, 'leftText', 'leftRevisionText', 'leftAuthorText', 'leftCommitText')
	rightPanel = Panel(builder, 'rightText', 'rightRevisionText', 'rightAuthorText', 'rightCommitText')

	head = repo.head.peel()
	rightPanel.show(head, path)

	previous = head.parents[0]
	leftPanel.show(previous, path)

	darea = builder.get_object('revisionGraph')
	darea.connect('draw', draw_cb)

	Gtk.main()
